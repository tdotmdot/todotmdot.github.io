<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>バス現在位置（Google Sheets → Leaflet）</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .panel { position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: #fff; padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15); font-family: system-ui, sans-serif;
      display: grid; gap: 8px; min-width: 280px; }
    .row { display: grid; gap: 6px; }
    .row label { font-size: 12px; color: #555; }
    .row input, .row select { padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
    .note { font-size: 12px; color: #666; }
    .pill { display: inline-block; padding: 2px 8px; font-size: 12px; border-radius: 999px; background:#f3f4f6; }
    .btn { cursor: pointer; border: 0; padding: 8px 10px; border-radius: 8px; background: #111827; color: #fff; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; white-space: pre-wrap; max-height: 28vh; overflow:auto; background:#0b1020; color:#c5e4ff; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="panel">
    <!--
    <div class="row">
      <label>Google Sheets 公開CSVのURL</label>
      <input id="csvUrl" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv&gid=..." />
      <div class="note">※ 「ウェブに公開」したシートのCSV URLを貼ってください。<br>
        列名は <span class="pill">bus_id</span> <span class="pill">lat</span> <span class="pill">lng</span> <span class="pill">timestamp</span> を推奨。</div>
    </div>
    <div class="row">
      <label>表示モード</label>
      <select id="mode">
        <option value="latest">最新の1点（マーカー）</option>
        <option value="track">軌跡（全行を折れ線＆最終点マーカー）</option>
      </select>
    </div>
    <div class="row">
      <label>自動更新（秒）</label>
      <input id="intervalSec" type="number" min="3" step="1" value="5" />
    </div>
    <div class="row" style="grid-auto-flow: column; grid-auto-columns: 1fr; gap: 8px;">
      <button class="btn" id="startBtn">開始</button>
      <button class="btn" id="stopBtn" style="background:#6b7280">停止</button>
    </div>
    -->
    <div class="note" id="status">待機中…</div>
    <div class="log" id="log">[log] 初期化完了</div>
  </div>

  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== ユーティリティ =====
    function $(id){ return document.getElementById(id); }
    function log(msg){ const el=$('log'); if(el){ el.textContent += `\n${new Date().toLocaleTimeString()} ${msg}`; el.scrollTop=el.scrollHeight; } console.log(msg); }

    let abortCtrl = null;
    
    async function fetchCsv(url){
      const sep=url.includes('?')?'&':'?';
      abortCtrl?.abort();                // ← 前回の取得を中断
      abortCtrl = new AbortController();
      const res = await fetch(url + sep + '_ts=' + Date.now(), {
        cache: 'no-store',
        signal: abortCtrl.signal
      });
      const text=await res.text();
//      log('[fetchCsv] '+res.status+' '+finalUrl+'\n'+text.slice(0,80));
      log('[fetchCsv] '+res.status + ' : ' + text);
      return parseCsv(text);
    }

    function parseCsv(text){
      const lines=text.trim().split(/\r?\n/);
      if(lines.length<2) return [];
      const headers=lines[0].split(',').map(s=>s.trim());
      const idx={ bus_id:headers.indexOf('bus_id'), lat:headers.indexOf('lat'), lng:headers.indexOf('lng'), timestamp:headers.indexOf('timestamp') };
      return lines.slice(1).map(line=>{
        const cols=line.split(',');
        return { bus_id: idx.bus_id>=0?cols[idx.bus_id]:'', lat: idx.lat>=0?parseFloat(cols[idx.lat]):NaN, lng: idx.lng>=0?parseFloat(cols[idx.lng]):NaN, timestamp: idx.timestamp>=0?cols[idx.timestamp]:'' };
      }).filter(r=>Number.isFinite(r.lat)&&Number.isFinite(r.lng));
    }

    function fitViewIfNeeded(latlngs){
      if(!latlngs.length) return;
      if(latlngs.length===1){ map.setView(latlngs[0],16); }
      else{ const bounds=L.latLngBounds(latlngs); map.fitBounds(bounds.pad(0.2)); }
    }

    let seq = 0;
    async function render(){
      //const url=$('csvUrl').value.trim();
      const url='https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4ctXQDM6uMC20lffc26TMiIW0E7Aj0As0Q4JLVwtFuL49c8WreK-UrZyaI2DJRbn6GICU7J5IyR7J/pub?gid=0&single=true&output=csv';

      const my = ++seq;
      if(!url){ $('status').textContent='CSVのURLを入力してください'; return; }
      $('status').textContent='更新中…';
      try{
        const rows=await fetchCsv(url);
        if (my !== seq){
          log('my !== seq');
          return; // 自分より新しい呼び出しがあれば無視
        }
        
//        log(seq + '[render] rows='+rows.length);
        if(!rows.length){ $('status').textContent='データがありません'; return; }
//        const mode=$('mode').value;
        const mode = 'latest';
        if(mode==='latest'){
          const last=rows[rows.length-1];

          if (last.timestamp) {
            const d2El = document.getElementById('d2time');
            const prevTs = d2El ? new Date(d2El.textContent) : null;
            const currTs = new Date(last.timestamp);
            if (prevTs && currTs < prevTs) {
              log('[render] skip: '+currTs+' < '+prevTs);
              return; // 古いのでスキップ
            }
            if (d2El) d2El.textContent = currTs.toISOString();
          }
          
          const latlng=[last.lat,last.lng];
　        log(latlng);
          $('status').textContent=`最新: ${last.timestamp||''} / ${latlng[0].toFixed(6)}, ${latlng[1].toFixed(6)} / bus_id: ${last.bus_id||'-'}`;
        } else {
          const latlngs=rows.map(r=>[r.lat,r.lng]);
          if(polyline) polyline.setLatLngs(latlngs); else polyline=L.polyline(latlngs,{weight:4}).addTo(map);
          const last=rows[rows.length-1];
          const lastLatLng=[last.lat,last.lng];
          if(!marker) marker=L.marker(lastLatLng).addTo(map);
          marker.setLatLng(lastLatLng);
//          fitViewIfNeeded(latlngs);
          $('status').textContent=`行数: ${rows.length} / 最新: ${last.timestamp||''} / ${lastLatLng[0].toFixed(6)}, ${lastLatLng[1].toFixed(6)} / bus_id: ${last.bus_id||'-'}`;
        }
      }catch(e){ $('status').textContent='エラー: '+e.message; log('[error] '+(e.stack||e.message)); }
    }

    // D2セル時刻の代わりにHTML内に隠し要素を置いて管理
    const hiddenD2=document.createElement('div');
    hiddenD2.id='d2time';
    hiddenD2.style.display='none';
    document.body.appendChild(hiddenD2);
    
    let running = false;

    async function start() {
      if (running) return;
      running = true;
    //  const intervalMs = Math.max(3000, Number($('#intervalSec').value) * 1000 || 5000);
      const intervalMs = Math.max(3000, 10 * 1000 || 5000);
      while (running) {
        await render();                  // ← fetchCsv() を待ってから
        await new Promise(r => setTimeout(r, intervalMs));  // 次の周期へ
      }
    }
    function stop(){ running = false; }
    //    $('startBtn').addEventListener('click',start);
    //    $('stopBtn').addEventListener('click',stop);
    start();
  </script>
</body>
</html>
